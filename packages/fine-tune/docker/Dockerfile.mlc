# Dockerfile for MLC LLM Model Compilation (WASM/WebGPU)
# Uses x86_64 for stable LLVM JIT compilation (runs via Rosetta on Apple Silicon)

FROM --platform=linux/amd64 ubuntu:22.04

# System deps
RUN apt-get update && apt-get install -yq \
    python3-dev python3-pip python3-venv \
    cmake git git-lfs curl build-essential \
    libxml2-dev pkg-config libssl-dev \
    llvm-dev libclang-dev nodejs npm

# Install modern Rust via rustup (Ubuntu repos are too old)
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Emscripten (required for WASM output)
RUN git clone https://github.com/emscripten-core/emsdk.git /opt/emsdk && \
    cd /opt/emsdk && \
    ./emsdk install latest && \
    ./emsdk activate latest

# MLC LLM from source with submodules (includes TVM)
# Pinned to WebLLM 0.2.80 known-good commit for Gemma 3 compatibility
ENV MLC_LLM_COMMIT=4084e7fe7532fb932810d8b707f2d760eefd0dea

RUN git clone https://github.com/mlc-ai/mlc-llm.git /opt/mlc-llm && \
    cd /opt/mlc-llm && git checkout ${MLC_LLM_COMMIT} && \
    git submodule update --init --recursive

# Build TVM Unity compiler
WORKDIR /opt/mlc-llm/3rdparty/tvm
RUN mkdir build && cd build && \
    cp ../cmake/config.cmake . && \
    echo "set(USE_LLVM ON)" >> config.cmake && \
    cmake .. && make -j$(nproc)

# Build MLC LLM
WORKDIR /opt/mlc-llm
RUN mkdir build && cd build && \
    cmake .. && make -j1

# Install Python packages
RUN pip3 install --upgrade pip && \
    pip3 install -e ./python && \
    pip3 install "numpy<2" decorator scipy tornado psutil && \
    rm -rf /root/.cache/pip

# Prepare Emscripten dependencies for WASM runtime
RUN /bin/bash -c "source /opt/emsdk/emsdk_env.sh && cd /opt/mlc-llm && ./web/prep_emcc_deps.sh"

# Environment
ENV TVM_HOME=/opt/mlc-llm/3rdparty/tvm
ENV MLC_LLM_SOURCE_DIR=/opt/mlc-llm
ENV PYTHONPATH="/opt/mlc-llm/3rdparty/tvm/python:/opt/mlc-llm/python"
ENV PATH="/opt/emsdk:/opt/emsdk/upstream/emscripten:${PATH}"

# Source emsdk on shell entry
RUN echo 'source /opt/emsdk/emsdk_env.sh' >> /root/.bashrc

WORKDIR /workspace
CMD ["/bin/bash"]
